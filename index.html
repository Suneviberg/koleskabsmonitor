<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <title>Køleskabsdetektor – Overvågning</title>
  <link rel="stylesheet" href="monitorStyles.css">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // Same Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBk_0onk9XhXjEj6a7gLGunDAdRAuypOkw",
      authDomain: "fridgedetector.firebaseapp.com",
      databaseURL: "https://fridgedetector-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "fridgedetector",
      storageBucket: "fridgedetector.firebasestorage.app",
      messagingSenderId: "715913930919",
      appId: "1:715913930919:web:b3a3a36bc4341579a71382"
    };

    // Initialize
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // 45s threshold
    const ALARM_THRESHOLD_MS = 45000;
    let alarmIsPlaying = false;
    let isOpenNow      = false;

    // We'll keep a local stopwatch too
    let openStartTime   = 0;
    let monitorInterval = null; // checks every 500ms

    let alarmAudio;
    let enableAudioBtn;

    document.addEventListener('DOMContentLoaded', () => {
      const currentStatusEl = document.getElementById('currentStatus');
      const logEntriesEl    = document.getElementById('logEntries');

      alarmAudio     = document.getElementById('monitorAlarm');
      enableAudioBtn = document.getElementById('enableAudioBtn');

      // Let user enable audio
      enableAudioBtn.addEventListener('click', () => {
        alarmAudio.play().then(() => {
          alarmAudio.pause();
          alarmAudio.currentTime = 0;
          console.log("Monitor alarm-larm aktiveret via brugerinteraktion.");
        }).catch(err => {
          console.warn("Monitor audio enable failed:", err);
        });
      });

      const currentStatusRef = ref(db, 'fridge/currentStatus');
      const logsRef          = ref(db, 'fridge/logs');

      // Listen for open/closed
      onValue(currentStatusRef, snapshot => {
        const val = snapshot.val();
        if (!val) {
          currentStatusEl.textContent = "Ingen status endnu...";
          stopMonitorWatch();
          stopAlarm();
          return;
        }

        if (val.isOpen) {
          currentStatusEl.textContent = "Åbent";
          if (!isOpenNow) {
            // We just transitioned from closed -> open
            isOpenNow = true;
            openStartTime = Date.now();
            startMonitorWatch();
          }
        } else {
          currentStatusEl.textContent = "Lukket";
          if (isOpenNow) {
            // closed -> stop local watch
            isOpenNow = false;
            stopMonitorWatch();
            stopAlarm();
          }
        }
      });

      // Logs
      onChildAdded(logsRef, snapshot => {
        const entry = snapshot.val();
        if (!entry) return;
        addLogEntry(logEntriesEl, entry);
      });
    });

    function startMonitorWatch() {
      if (monitorInterval) return;
      monitorInterval = setInterval(() => {
        const now = Date.now();
        const elapsed = now - openStartTime;
        if (elapsed >= ALARM_THRESHOLD_MS && !alarmIsPlaying) {
          startAlarm();
        }
      }, 500);
    }

    function stopMonitorWatch() {
      if (monitorInterval) {
        clearInterval(monitorInterval);
        monitorInterval = null;
      }
      openStartTime = 0;
    }

    function startAlarm() {
      alarmIsPlaying = true;
      try {
        alarmAudio.play().catch(err => {
          console.warn("Monitor alarm error:", err);
        });
      } catch (err) {
        console.warn("Monitor alarm exception:", err);
      }
    }

    function stopAlarm() {
      alarmIsPlaying = false;
      if (!alarmAudio.paused) {
        alarmAudio.pause();
        alarmAudio.currentTime = 0;
      }
    }

    // Log
    function addLogEntry(container, entry) {
      const div = document.createElement('div');
      const startStr = formatClockTime(new Date(entry.start));
      const endStr   = formatClockTime(new Date(entry.end));
      const durStr   = formatDuration(entry.durationMs || 0);

      div.textContent = `Åbent: ${startStr} - ${endStr} (Varighed: ${durStr})`;
      container.prepend(div);
    }

    function formatClockTime(dateObj) {
      const hh = String(dateObj.getHours()).padStart(2,'0');
      const mm = String(dateObj.getMinutes()).padStart(2,'0');
      const ss = String(dateObj.getSeconds()).padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }

    function formatDuration(ms) {
      let total = Math.floor(ms / 1000);
      const hh  = Math.floor(total / 3600);
      total    %= 3600;
      const mm  = Math.floor(total / 60);
      const ss  = total % 60;
      return [hh, mm, ss].map(n => String(n).padStart(2,'0')).join(':');
    }
  </script>
</head>
<body>
  <div class="monitor-container">
    <h1>Køleskabsdetektor – Overvågning</h1>

    <div class="status-box">
      <h2>Aktuel Status</h2>
      <p id="currentStatus">Henter data...</p>
    </div>

    <div class="log-box">
      <h2>Log</h2>
      <div id="logEntries"></div>
    </div>
  </div>

  <!-- Alarm audio (loop) for monitor -->
  <audio id="monitorAlarm" loop style="display:none;">
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.mp3" type="audio/mpeg">
    Din browser understøtter ikke afspilning af alarm-lyd.
  </audio>

  <!-- “Enable Audio” button for the monitor page -->
  <button id="enableAudioBtn" style="position: absolute; top:10px; right:10px;">
    Aktivér alarm-lyd
  </button>
</body>
</html>
