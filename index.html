<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <title>Køleskabsdetektor – Overvågning</title>
  <link rel="stylesheet" href="monitorStyles.css">

  <!-- Firebase Modules (using ES Modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // Your Firebase config (must be identical to the Detector page)
    const firebaseConfig = {
      apiKey: "AIzaSyBk_0onk9XhXjEj6a7gLGunDAdRAuypOkw",
      authDomain: "fridgedetector.firebaseapp.com",
      databaseURL: "https://fridgedetector-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "fridgedetector",
      storageBucket: "fridgedetector.firebasestorage.app",
      messagingSenderId: "715913930919",
      appId: "1:715913930919:web:b3a3a36bc4341579a71382"
    };

    // Initialize Firebase and export the database reference if needed
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    window.FridgeDB = { db };  // In our monitor code we use local database reference
  </script>

  <!-- Main Monitor Script -->
  <script type="module">
    import { getDatabase, ref, onValue, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    
    const ALARM_THRESHOLD_MS = 45000; // 45 seconds for the alarm
    
    // Global variables for statistics
    let openingCount = 0;
    let totalOpenTime = 0; // in milliseconds
    let lastLogEndTime = 0;
    
    // Stopwatch for current opening
    let currentOpenStart = 0;
    let currentInterval = null;
    
    // Alarm flag
    let alarmIsPlaying = false;
    
    let monitorAlarm;
    let checkInterval; // for alarm check
    
    document.addEventListener('DOMContentLoaded', () => {
      // Grab UI elements
      const currentStatusEl = document.getElementById('currentStatus');
      const logEntriesEl    = document.getElementById('logEntries');
      const openingCountEl  = document.getElementById('openingCount');
      const averageOpenEl   = document.getElementById('averageOpenTime');
      const currentOpenEl   = document.getElementById('currentOpeningDuration');
      const timeSinceOpenEl = document.getElementById('timeSinceLastOpen');

      // Alarm audio and Enable Audio button
      monitorAlarm = document.getElementById('monitorAlarm');
      const enableAudioBtn = document.getElementById('enableAudioBtn');

      // Let user enable audio (unlocking audio playback)
      enableAudioBtn.addEventListener('click', () => {
        // Mute during play/pause to avoid sound
        const oldVol = monitorAlarm.volume;
        monitorAlarm.volume = 0;
        monitorAlarm.play().then(() => {
          monitorAlarm.pause();
          monitorAlarm.currentTime = 0;
          monitorAlarm.volume = oldVol;
          console.log("Monitor alarm unlocked via user interaction.");
        }).catch(err => {
          console.warn("Monitor audio enable failed:", err);
        });
      });
      
      const db = window.FridgeDB.db;
      const currentStatusRef = ref(db, 'fridge/currentStatus');
      const logsRef = ref(db, 'fridge/logs');

      // Listen for current status
      onValue(currentStatusRef, snapshot => {
        const val = snapshot.val();
        if (!val) {
          currentStatusEl.textContent = "Ingen status endnu...";
          stopCurrentWatch();
          stopAlarm();
          return;
        }
        
        // Update current status text
        currentStatusEl.textContent = val.isOpen ? "Åbent" : "Lukket";
        
        if (val.isOpen) {
          // When open, we record the start time (only if it changes)
          if (!currentOpenStart || currentOpenStart === 0) {
            currentOpenStart = val.startTime || Date.now();
            startCurrentWatch();
          }
        } else {
          // If closed, reset the current watch and show time since last open
          stopCurrentWatch();
          // Update "Time Since Last Open"
          if (lastLogEndTime) {
            updateTimeSinceLastOpen();
          } else {
            document.getElementById('timeSinceLastOpen').textContent = "--:--:--";
          }
          // Reset current open time
          currentOpenStart = 0;
          stopAlarm();
        }
      });

      // Listen for new log entries
      onChildAdded(logsRef, snapshot => {
        const entry = snapshot.val();
        if (!entry) return;
        addLogEntry(logEntriesEl, entry);
        // Update statistics (openingCount & totalOpenTime)
        openingCount++;
        totalOpenTime += entry.durationMs || 0;
        lastLogEndTime = entry.end;
        openingCountEl.textContent = openingCount;
        averageOpenEl.textContent = formatTime(totalOpenTime / openingCount);
      });
      
      // Start an interval to update "Time Since Last Open" if closed.
      setInterval(() => {
        if (currentStatusEl.textContent === "Lukket" && lastLogEndTime) {
          updateTimeSinceLastOpen();
        }
      }, 1000);
    });
    
    function startCurrentWatch() {
      if (currentInterval) return;
      currentInterval = setInterval(() => {
        const elapsed = Date.now() - currentOpenStart;
        document.getElementById('currentOpeningDuration').textContent = formatTime(elapsed);
        // If elapsed is above 45 seconds and alarm isn't playing, then trigger alarm
        if (elapsed >= ALARM_THRESHOLD_MS && !alarmIsPlaying) {
          startAlarm();
        }
      }, 500);
    }
    
    function stopCurrentWatch() {
      if (currentInterval) {
        clearInterval(currentInterval);
        currentInterval = null;
      }
      document.getElementById('currentOpeningDuration').textContent = "00:00:00";
    }
    
    function updateTimeSinceLastOpen() {
      const elapsed = Date.now() - lastLogEndTime;
      document.getElementById('timeSinceLastOpen').textContent = formatTime(elapsed);
    }
    
    function startAlarm() {
      alarmIsPlaying = true;
      try {
        monitorAlarm.play().catch(err => {
          console.warn("Monitor alarm error:", err);
        });
      } catch (err) {
        console.warn("Monitor alarm exception:", err);
      }
    }
    
    function stopAlarm() {
      alarmIsPlaying = false;
      if (!monitorAlarm.paused) {
        monitorAlarm.pause();
        monitorAlarm.currentTime = 0;
      }
    }
    
    function addLogEntry(container, entry) {
      const div = document.createElement('div');
      const startStr = formatClockTime(new Date(entry.start));
      const endStr = formatClockTime(new Date(entry.end));
      const durStr = formatTime(entry.durationMs || 0);
      div.textContent = `Åbnet: ${startStr} - ${endStr} (Varighed: ${durStr})`;
      container.prepend(div);
    }
    
    function formatTime(ms) {
      let totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      totalSeconds %= 3600;
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return [hours, minutes, seconds].map(n => String(n).padStart(2, '0')).join(':');
    }
    
    function formatClockTime(dateObj) {
      const hh = String(dateObj.getHours()).padStart(2, '0');
      const mm = String(dateObj.getMinutes()).padStart(2, '0');
      const ss = String(dateObj.getSeconds()).padStart(2, '0');
      return `${hh}:${mm}:${ss}`;
    }
  </script>
</head>
<body>
  <div class="monitor-container">
    <h1>Køleskabsdetektor – Overvågning</h1>
    
    <div class="status-box">
      <h2>Aktuel Status</h2>
      <p id="currentStatus">Henter data...</p>
    </div>
    
    <div class="stats-box">
      <h2>Statistik</h2>
      <p>Antal åbninger: <span id="openingCount">0</span></p>
      <p>Gennemsnitlig åbningstid: <span id="averageOpenTime">00:00:00</span></p>
      <p>Aktuel åbning: <span id="currentOpeningDuration">00:00:00</span></p>
      <p>Siden sidst åbnet: <span id="timeSinceLastOpen">00:00:00</span></p>
    </div>
    
    <div class="log-box">
      <h2>Log</h2>
      <div id="logEntries"></div>
    </div>
  </div>

  <!-- Alarm audio (loop) for monitor -->
  <audio id="monitorAlarm" loop style="display:none;">
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.mp3" type="audio/mpeg">
    Din browser understøtter ikke afspilning af alarm-lyd.
  </audio>

  <!-- Enable Audio button -->
  <button id="enableAudioBtn" class="enable-audio-btn">Aktivér alarm-lyd</button>
</body>
</html>
