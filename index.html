<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <title>Køleskabsdetektor v3000</title>
  <link rel="stylesheet" href="monitorStyles.css">

  <!-- Firebase Modules (ES Modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // Firebase configuration (must match the Detector configuration)
    const firebaseConfig = {
      apiKey: "AIzaSyBk_0onk9XhXjEj6a7gLGunDAdRAuypOkw",
      authDomain: "fridgedetector.firebaseapp.com",
      databaseURL: "https://fridgedetector-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "fridgedetector",
      storageBucket: "fridgedetector.firebasestorage.app",
      messagingSenderId: "715913930919",
      appId: "1:715913930919:web:b3a3a36bc4341579a71382"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window.FridgeDB = { db };
  </script>

  <!-- Main Monitor Script -->
  <script type="module">
    import { getDatabase, ref, onValue, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    
    // Set the 45-second threshold for the alarm
    const ALARM_THRESHOLD_MS = 45000;
    let alarmIsPlaying = false;
    let monitorInterval = null; // for local stopwatch when fridge is open
    let currentOpenStart = 0;
    
    // Array to hold log entries for statistics
    let allLogs = [];
    
    // Statistics variables
    let countAll = 0, totalAll = 0;
    let countMonth = 0, totalMonth = 0;
    let countWeek = 0, totalWeek = 0;
    let countDay = 0, totalDay = 0;
    
    // For tracking the last closing timestamp (for "time since last open")
    let lastLogEndTime = 0;
    
    document.addEventListener('DOMContentLoaded', () => {
      const currentStatusEl = document.getElementById('currentStatus');
      const statusBox = document.querySelector('.status-box'); // Our box we want to color
      const logEntriesEl = document.getElementById('logEntries');
      
      // Statistics elements
      const totalBoxCountEl = document.getElementById('totalAllCount');
      const totalBoxAvgEl   = document.getElementById('averageAllTime');
      const monthBoxCountEl = document.getElementById('totalMonthCount');
      const monthBoxAvgEl   = document.getElementById('averageMonth');
      const weekBoxCountEl  = document.getElementById('totalWeekCount');
      const weekBoxAvgEl    = document.getElementById('averageWeek');
      const dayBoxCountEl   = document.getElementById('totalDayCount');
      const dayBoxAvgEl     = document.getElementById('averageDay');
      
      // Current opening duration and time since last open:
      const currentOpenEl   = document.getElementById('currentOpeningDuration');
      const timeSinceOpenEl = document.getElementById('timeSinceLastOpen');
      
      const db = window.FridgeDB.db;
      const currentStatusRef = ref(db, 'fridge/currentStatus');
      const logsRef = ref(db, 'fridge/logs');
      
      // Alarm audio and Enable Audio button
      const alarmAudio = document.getElementById('monitorAlarm');
      const enableAudioBtn = document.getElementById('enableAudioBtn');
      
      // Enable audio unlocking via user click
      enableAudioBtn.addEventListener('click', () => {
        const oldVol = alarmAudio.volume;
        alarmAudio.volume = 0;
        alarmAudio.play().then(() => {
          alarmAudio.pause();
          alarmAudio.currentTime = 0;
          alarmAudio.volume = oldVol;
          console.log("Monitor alarm unlocked via user interaction.");
        }).catch(err => {
          console.warn("Monitor audio unlock failed:", err);
        });
      });
      
      // Listen for changes to the current status from Firebase
      onValue(currentStatusRef, snapshot => {
        const val = snapshot.val();
        if (!val) {
          currentStatusEl.textContent = "Ingen status endnu...";
          stopMonitorWatch();
          stopAlarm(alarmAudio);
          return;
        }
        currentStatusEl.textContent = val.isOpen ? "Åbent" : "Lukket";
        // Update the background color of status-box based on status:
        if (val.isOpen) {
          // When open, set color to red (#cc0000)
          statusBox.style.backgroundColor = "#660000";
          if (!currentOpenStart || currentOpenStart === 0) {
            currentOpenStart = val.startTime || Date.now();
            startMonitorWatch(alarmAudio);
          }
        } else {
          // When closed, set color to green (#1a6600)
          statusBox.style.backgroundColor = "#1a6600";
          stopMonitorWatch();
          stopAlarm(alarmAudio);
          updateTimeSinceLastOpen();
          currentOpenStart = 0;
        }
      });
      
      // Listen for new log entries
      onChildAdded(logsRef, snapshot => {
        const entry = snapshot.val();
        if (!entry) return;
        addLogEntry(logEntriesEl, entry);
        allLogs.push(entry);
        updateStatistics();
      });
      
      // Update dynamic stats every second
      setInterval(() => {
        if (document.getElementById('currentStatus').textContent === "Åbent" && currentOpenStart) {
          currentOpenEl.textContent = formatTime(Date.now() - currentOpenStart);
        } else {
          currentOpenEl.textContent = "00:00:00";
        }
        if (document.getElementById('currentStatus').textContent === "Lukket" && lastLogEndTime) {
          updateTimeSinceLastOpen();
        }
      }, 1000);
      
      // Update statistics function
      function updateStatistics() {
        // Reset counters
        countAll = 0; totalAll = 0;
        countMonth = 0; totalMonth = 0;
        countWeek = 0; totalWeek = 0;
        countDay = 0; totalDay = 0;
        
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();
        const currentDate = now.getDate();
        
        // For week: entries from the last 7 days
        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        
        for (const entry of allLogs) {
          countAll++;
          totalAll += entry.durationMs || 0;
          
          const entryDate = new Date(entry.start);
          if (entryDate.getFullYear() === currentYear && entryDate.getMonth() === currentMonth) {
            countMonth++;
            totalMonth += entry.durationMs || 0;
          }
          if (entryDate >= weekAgo) {
            countWeek++;
            totalWeek += entry.durationMs || 0;
          }
          if (entryDate.getFullYear() === currentYear &&
              entryDate.getMonth() === currentMonth &&
              entryDate.getDate() === currentDate) {
            countDay++;
            totalDay += entry.durationMs || 0;
          }
        }
        
        document.getElementById('totalAllCount').textContent = countAll;
        document.getElementById('averageAllTime').textContent = countAll > 0 ? formatTime(totalAll / countAll) : "00:00:00";
        
        document.getElementById('totalMonthCount').textContent = countMonth;
        document.getElementById('averageMonth').textContent = countMonth > 0 ? formatTime(totalMonth / countMonth) : "00:00:00";
        
        document.getElementById('totalWeekCount').textContent = countWeek;
        document.getElementById('averageWeek').textContent = countWeek > 0 ? formatTime(totalWeek / countWeek) : "00:00:00";
        
        document.getElementById('totalDayCount').textContent = countDay;
        document.getElementById('averageDay').textContent = countDay > 0 ? formatTime(totalDay / countDay) : "00:00:00";
      }
    });
    
    function startMonitorWatch(alarmAudio) {
      if (monitorInterval) return;
      monitorInterval = setInterval(() => {
        const elapsed = Date.now() - currentOpenStart;
        if (elapsed >= ALARM_THRESHOLD_MS && !alarmIsPlaying) {
          startAlarm(alarmAudio);
        }
      }, 500);
    }
    
    function stopMonitorWatch() {
      if (monitorInterval) {
        clearInterval(monitorInterval);
        monitorInterval = null;
      }
    }
    
    function startAlarm(alarmAudio) {
      alarmIsPlaying = true;
      try {
        alarmAudio.play().catch(err => {
          console.warn("Monitor alarm error:", err);
        });
      } catch (err) {
        console.warn("Monitor alarm exception:", err);
      }
    }
    
    function stopAlarm(alarmAudio) {
      alarmIsPlaying = false;
      if (!alarmAudio.paused) {
        alarmAudio.pause();
        alarmAudio.currentTime = 0;
      }
    }
    
    function addLogEntry(container, entry) {
      const div = document.createElement('div');
      const startStr = formatClockTime(new Date(entry.start));
      const endStr = formatClockTime(new Date(entry.end));
      const durStr = formatTime(entry.durationMs || 0);
      div.textContent = `Åbnet: ${startStr} - ${endStr} (Varighed: ${durStr})`;
      container.prepend(div);
      // Update last log end time
      lastLogEndTime = entry.end;
    }
    
    function updateTimeSinceLastOpen() {
      if (!lastLogEndTime) return;
      const elapsed = Date.now() - lastLogEndTime;
      document.getElementById('timeSinceLastOpen').textContent = formatTime(elapsed);
    }
    
    function formatTime(ms) {
      let totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      totalSeconds %= 3600;
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return [hours, minutes, seconds]
              .map(n => String(n).padStart(2, '0'))
              .join(':');
    }
    
    function formatClockTime(dateObj) {
      const hh = String(dateObj.getHours()).padStart(2, '0');
      const mm = String(dateObj.getMinutes()).padStart(2, '0');
      const ss = String(dateObj.getSeconds()).padStart(2, '0');
      return `${hh}:${mm}:${ss}`;
    }
  </script>
</head>
<body>
  <div class="monitor-container">
    <h1>Køleskabsdetektor v3000</h1>
    
    <div class="status-box">
      <h3>Aktuel Status</h3>
      <h1 id="currentStatus">Henter data...</h1>
    </div>
    
    <div class="stats-box">
      <div class="stat-group">
        <h2><span id="currentOpeningDuration">00:00:00</span></h2>
        <p>Aktuel åbning</p>
      </div>
      <div class="stat-group">
        <h2><span id="timeSinceLastOpen">00:00:00</span></h2>
        <p>Tid siden sidste åbning</p>
      </div>
      <div class="stat-group">
        <h3>Alle</h3>
        <p>Antal åbninger: <span id="totalAllCount">0</span></p>
        <p>Gennemsnitlig åbningstid: <span id="averageAllTime">00:00:00</span></p>
      </div>
      <div class="stat-group">
        <h3>Måned</h3>
        <div class="stat-sub-group-container">
          <div class="stat-sub-group">
            <h2 class="stat-counter"><span id="totalMonthCount">0</span></h2>
            <p class="stat-description">Åbninger</p>
          </div>
       <div class="stat-sub-group">
            <h2 class="stat-counter"><span id="averageMonth">00:00:00</span></h2>
            <p class="stat-description">Gns. Åbningstid</p>
          </div>
          </div>   
      </div>
      <div class="stat-group">
        <h3>Uge</h3>
        <p>Antal åbninger: <span id="totalWeekCount">0</span></p>
        <p>Gennemsnitlig åbningstid: <span id="averageWeek">00:00:00</span></p>
      </div>
      <div class="stat-group">
        <h3>Dag</h3>
        <p>Antal åbninger: <span id="totalDayCount">0</span></p>
        <p>Gennemsnitlig åbningstid: <span id="averageDay">00:00:00</span></p>
      </div>
    </div>
    
    <div class="log-box">
      <h2>Log</h2>
      <div id="logEntries"></div>
    </div>
    
    <!-- Place Enable Audio button below the log -->
    <button id="enableAudioBtn" class="enable-audio-btn">Aktivér alarm-lyd</button>
  </div>

  <!-- Alarm audio (loop) for monitor -->
  <audio id="monitorAlarm" loop style="display:none;">
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.mp3" type="audio/mpeg">
    Din browser understøtter ikke afspilning af alarm-lyd.
  </audio>
</body>
</html>
