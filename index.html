<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <title>Køleskabsdetektor v3000</title>
  <link rel="stylesheet" href="monitorStyles.css">

  <!-- Firebase Modules (ES Modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // Firebase configuration (must match the Detector configuration)
    const firebaseConfig = {
      apiKey: "AIzaSyBk_0onk9XhXjEj6a7gLGunDAdRAuypOkw",
      authDomain: "fridgedetector.firebaseapp.com",
      databaseURL: "https://fridgedetector-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "fridgedetector",
      storageBucket: "fridgedetector.firebasestorage.app",
      messagingSenderId: "715913930919",
      appId: "1:715913930919:web:b3a3a36bc4341579a71382"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window.FridgeDB = { db };
  </script>

  <!-- Main Monitor Script -->
  <script type="module">
    import { getDatabase, ref, onValue, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    
    // 45-second alarm threshold
    const ALARM_THRESHOLD_MS = 45000;
    let alarmIsPlaying = false;
    let monitorInterval = null; 
    let currentOpenStart = 0;
    
    // All logs
    let allLogs = [];

    // We'll track alarm triggers in memory:
    let alarmActivations = []; // array of timestamps (when the alarm triggered)

    // Old “countAll” style variables
    let countAll = 0, totalAll = 0;
    let countMonth = 0, totalMonth = 0;
    let countWeek = 0, totalWeek = 0;
    let countDay = 0, totalDay = 0;
    
    // For "time since last open"
    let lastLogEndTime = 0;
    
    // New stats for Big Box
    let openCountAll = 0, alarmTogglesAll = 0, longestOpenAll = 0, avgOpenAll = 0;
    let openCountMonth = 0, alarmTogglesMonth = 0, longestOpenMonth = 0, avgOpenMonth = 0;
    let openCountWeek = 0, alarmTogglesWeek = 0, longestOpenWeek = 0, avgOpenWeek = 0;
    let openCountDay = 0, alarmTogglesDay = 0, longestOpenDay = 0, avgOpenDay = 0;

    // Current scope for the Big Box
    let currentScope = "all"; // one of ["all", "month", "week", "day"]

    document.addEventListener('DOMContentLoaded', () => {
      const currentStatusEl  = document.getElementById('currentStatus');
      const statusBox        = document.querySelector('.status-box');
      const logEntriesEl     = document.getElementById('logEntries');
      
      // Existing older stat references
      const totalBoxCountEl  = document.getElementById('totalAllCount');
      const totalBoxAvgEl    = document.getElementById('averageAllTime');
      const monthBoxCountEl  = document.getElementById('totalMonthCount');
      const monthBoxAvgEl    = document.getElementById('averageMonth');
      const weekBoxCountEl   = document.getElementById('totalWeekCount');
      const weekBoxAvgEl     = document.getElementById('averageWeek');
      const dayBoxCountEl    = document.getElementById('totalDayCount');
      const dayBoxAvgEl      = document.getElementById('averageDay');
      
      // Current Opening & Time Since Opening
      const currentOpenEl    = document.getElementById('currentOpeningDuration');
      const timeSinceOpenEl  = document.getElementById('timeSinceLastOpen');
      
      // Big Box toggle references
      const iosToggleAll     = document.getElementById('iosToggleAll');
      const iosToggleMonth   = document.getElementById('iosToggleMonth');
      const iosToggleWeek    = document.getElementById('iosToggleWeek');
      const iosToggleDay     = document.getElementById('iosToggleDay');

      // The 4 columns in “Big Box”
      const bigBoxOpenings      = document.getElementById('bigBoxOpenings');
      const bigBoxAlarmToggles  = document.getElementById('bigBoxAlarmToggles');
      const bigBoxLongestOpen   = document.getElementById('bigBoxLongestOpen');
      const bigBoxAvgOpen       = document.getElementById('bigBoxAvgOpen');

      // Alarm audio + button
      const alarmAudio       = document.getElementById('monitorAlarm');
      const enableAudioBtn   = document.getElementById('enableAudioBtn');
      
      enableAudioBtn.addEventListener('click', () => {
        const oldVol = alarmAudio.volume;
        alarmAudio.volume = 0;
        alarmAudio.play().then(() => {
          alarmAudio.pause();
          alarmAudio.currentTime = 0;
          alarmAudio.volume = oldVol;
          console.log("Monitor alarm unlocked via user interaction.");
        }).catch(err => {
          console.warn("Monitor audio unlock failed:", err);
        });
      });

      // iOS toggle event listeners
      iosToggleAll.addEventListener('click', () => {
        currentScope = "all";
        updateScopeButtons();
        updateBigBoxDisplay();
      });
      iosToggleMonth.addEventListener('click', () => {
        currentScope = "month";
        updateScopeButtons();
        updateBigBoxDisplay();
      });
      iosToggleWeek.addEventListener('click', () => {
        currentScope = "week";
        updateScopeButtons();
        updateBigBoxDisplay();
      });
      iosToggleDay.addEventListener('click', () => {
        currentScope = "day";
        updateScopeButtons();
        updateBigBoxDisplay();
      });

      function updateScopeButtons() {
        iosToggleAll.classList.remove('active');
        iosToggleMonth.classList.remove('active');
        iosToggleWeek.classList.remove('active');
        iosToggleDay.classList.remove('active');
        if (currentScope === "all")   iosToggleAll.classList.add('active');
        if (currentScope === "month") iosToggleMonth.classList.add('active');
        if (currentScope === "week")  iosToggleWeek.classList.add('active');
        if (currentScope === "day")   iosToggleDay.classList.add('active');
      }
      updateScopeButtons(); // set initial

      // Setup Firebase references
      const db = window.FridgeDB.db;
      const currentStatusRef = ref(db, 'fridge/currentStatus');
      const logsRef          = ref(db, 'fridge/logs');
      
      // Listen for current status changes
      onValue(currentStatusRef, snapshot => {
        const val = snapshot.val();
        if (!val) {
          currentStatusEl.textContent = "Ingen status endnu...";
          stopMonitorWatch();
          stopAlarm(alarmAudio);
          return;
        }
        currentStatusEl.textContent = val.isOpen ? "Åbent" : "Lukket";
        if (val.isOpen) {
          statusBox.style.backgroundColor = "#660000"; // open color
          if (!currentOpenStart) {
            currentOpenStart = val.startTime || Date.now();
            startMonitorWatch(alarmAudio);
          }
        } else {
          statusBox.style.backgroundColor = "#1a6600"; // closed color
          stopMonitorWatch();
          stopAlarm(alarmAudio);
          updateTimeSinceLastOpen();
          currentOpenStart = 0;
        }
      });
      
      // Logs
      onChildAdded(logsRef, snapshot => {
        const entry = snapshot.val();
        if (!entry) return;
        addLogEntry(logEntriesEl, entry);
        allLogs.push(entry);
        updateStatistics();
      });
      
      // Update dynamic fields (current open/time since open) every second
      setInterval(() => {
        if (currentStatusEl.textContent === "Åbent" && currentOpenStart) {
          currentOpenEl.textContent = formatTime(Date.now() - currentOpenStart);
        } else {
          currentOpenEl.textContent = "00:00:00";
        }
        if (currentStatusEl.textContent === "Lukket" && lastLogEndTime) {
          updateTimeSinceLastOpen();
        }
      }, 1000);

      // Recompute all stats
      function updateStatistics() {
        // Reset big box stats
        openCountAll=0; alarmTogglesAll=0; longestOpenAll=0; avgOpenAll=0;
        openCountMonth=0; alarmTogglesMonth=0; longestOpenMonth=0; avgOpenMonth=0;
        openCountWeek=0; alarmTogglesWeek=0; longestOpenWeek=0; avgOpenWeek=0;
        openCountDay=0; alarmTogglesDay=0; longestOpenDay=0; avgOpenDay=0;

        // For older “countAll” style
        countAll=0; totalAll=0;
        countMonth=0; totalMonth=0;
        countWeek=0; totalWeek=0;
        countDay=0; totalDay=0;

        let totalDurAll=0, totalDurMonth=0, totalDurWeek=0, totalDurDay=0;

        const now = new Date();
        const currentYear  = now.getFullYear();
        const thisMonth    = now.getMonth();
        const thisDate     = now.getDate();
        const weekAgo      = new Date(now.getTime() - 7 * 86400000);

        // 1) Process log entries
        for(const entry of allLogs) {
          const dur = entry.durationMs || 0;
          // "All"
          openCountAll++;
          totalDurAll += dur;
          if(dur> longestOpenAll) longestOpenAll= dur;

          countAll++;
          totalAll+= dur;

          const eDate= new Date(entry.start);
          // "Month"
          if(eDate.getFullYear()===currentYear && eDate.getMonth()===thisMonth){
            openCountMonth++;
            totalDurMonth+= dur;
            if(dur> longestOpenMonth) longestOpenMonth=dur;

            countMonth++;
            totalMonth+= dur;
          }
          // "Week"
          if(eDate >= weekAgo){
            openCountWeek++;
            totalDurWeek+= dur;
            if(dur> longestOpenWeek) longestOpenWeek= dur;

            countWeek++;
            totalWeek+= dur;
          }
          // "Day"
          if(eDate.getFullYear()===currentYear && eDate.getMonth()===thisMonth && eDate.getDate()===thisDate){
            openCountDay++;
            totalDurDay+= dur;
            if(dur> longestOpenDay) longestOpenDay= dur;

            countDay++;
            totalDay+= dur;
          }
        }

        // 2) Check alarmActivations for toggles
        // Each time alarm was triggered, we see if it belongs in all / month / week / day
        for(const ts of alarmActivations){
          // "All"
          alarmTogglesAll++;
          const aDate= new Date(ts);

          // "Month"
          if(aDate.getFullYear()===currentYear && aDate.getMonth()===thisMonth){
            alarmTogglesMonth++;
          }
          // "Week"
          if(aDate >= weekAgo){
            alarmTogglesWeek++;
          }
          // "Day"
          if(aDate.getFullYear()===currentYear && aDate.getMonth()===thisMonth && aDate.getDate()===thisDate){
            alarmTogglesDay++;
          }
        }

        // 3) Calculate Averages
        avgOpenAll   = openCountAll   ? (totalDurAll / openCountAll) : 0;
        avgOpenMonth = openCountMonth ? (totalDurMonth / openCountMonth) : 0;
        avgOpenWeek  = openCountWeek  ? (totalDurWeek / openCountWeek) : 0;
        avgOpenDay   = openCountDay   ? (totalDurDay / openCountDay) : 0;

        // 4) Update older stats
        totalBoxCountEl.textContent= countAll;
        totalBoxAvgEl.textContent= countAll>0 ? formatTime(totalAll/countAll) : "00:00:00";

        monthBoxCountEl.textContent= countMonth;
        monthBoxAvgEl.textContent= countMonth>0 ? formatTime(totalMonth/countMonth):"00:00:00";

        weekBoxCountEl.textContent= countWeek;
        weekBoxAvgEl.textContent= countWeek>0 ? formatTime(totalWeek/countWeek):"00:00:00";

        dayBoxCountEl.textContent= countDay;
        dayBoxAvgEl.textContent= countDay>0 ? formatTime(totalDay/countDay):"00:00:00";

        // 5) Update the “Big Box”
        updateBigBoxDisplay();
      }

      function updateBigBoxDisplay(){
        const bigBoxOpenings    = document.getElementById('bigBoxOpenings');
        const bigBoxAlarmToggles= document.getElementById('bigBoxAlarmToggles');
        const bigBoxLongestOpen = document.getElementById('bigBoxLongestOpen');
        const bigBoxAvgOpen     = document.getElementById('bigBoxAvgOpen');

        let openings=0, alarmCount=0, longestOpen=0, avgOpen=0;
        if(currentScope==="all"){
          openings   = openCountAll;
          alarmCount = alarmTogglesAll;
          longestOpen= longestOpenAll;
          avgOpen    = avgOpenAll;
        } else if(currentScope==="month"){
          openings   = openCountMonth;
          alarmCount = alarmTogglesMonth;
          longestOpen= longestOpenMonth;
          avgOpen    = avgOpenMonth;
        } else if(currentScope==="week"){
          openings   = openCountWeek;
          alarmCount = alarmTogglesWeek;
          longestOpen= longestOpenWeek;
          avgOpen    = avgOpenWeek;
        } else if(currentScope==="day"){
          openings   = openCountDay;
          alarmCount = alarmTogglesDay;
          longestOpen= longestOpenDay;
          avgOpen    = avgOpenDay;
        }

        bigBoxOpenings.textContent    = openings.toString();
        bigBoxAlarmToggles.textContent= alarmCount.toString();
        bigBoxLongestOpen.textContent = formatTime(longestOpen);
        bigBoxAvgOpen.textContent     = formatTime(avgOpen);
      }
    });

    // Monitor watch + alarm
    function startMonitorWatch(alarmAudio){
      if(monitorInterval) return;
      monitorInterval= setInterval(()=>{
        const elapsed= Date.now()-currentOpenStart;
        if(elapsed >= ALARM_THRESHOLD_MS && !alarmIsPlaying){
          startAlarm(alarmAudio);
        }
      },500);
    }
    function stopMonitorWatch(){
      if(monitorInterval){
        clearInterval(monitorInterval);
        monitorInterval=null;
      }
    }
    function startAlarm(alarmAudio){
      alarmIsPlaying=true;
      // Here we record that alarm toggled, storing the timestamp
      alarmActivations.push(Date.now());

      try{
        alarmAudio.play().catch(err=>{
          console.warn("Monitor alarm error:",err);
        });
      }catch(err){
        console.warn("Monitor alarm exception:",err);
      }
    }
    function stopAlarm(alarmAudio){
      alarmIsPlaying=false;
      if(!alarmAudio.paused){
        alarmAudio.pause();
        alarmAudio.currentTime=0;
      }
    }

    // Add logs
    function addLogEntry(container, entry){
      const div=document.createElement('div');
      const startStr= formatClockTime(new Date(entry.start));
      const endStr=   formatClockTime(new Date(entry.end));
      const durStr=   formatTime(entry.durationMs||0);
      div.textContent=`Åbnet: ${startStr} - ${endStr} (Varighed: ${durStr})`;
      container.prepend(div);
      lastLogEndTime= entry.end;
    }

    function updateTimeSinceLastOpen(){
      if(!lastLogEndTime) return;
      const elapsed= Date.now()-lastLogEndTime;
      document.getElementById('timeSinceLastOpen').textContent= formatTime(elapsed);
    }

    function formatTime(ms){
      let totalSeconds= Math.floor(ms/1000);
      const hours= Math.floor(totalSeconds/3600);
      totalSeconds%=3600;
      const minutes= Math.floor(totalSeconds/60);
      const seconds= totalSeconds%60;
      return [hours,minutes,seconds].map(n=> String(n).padStart(2,'0')).join(':');
    }
    function formatClockTime(dateObj){
      const hh= String(dateObj.getHours()).padStart(2,'0');
      const mm= String(dateObj.getMinutes()).padStart(2,'0');
      const ss= String(dateObj.getSeconds()).padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }
  </script>
</head>

<body>
  <div class="monitor-container">
    <h1>Køleskabsdetektor v3000</h1>
    
    <!-- Status Box -->
    <div class="status-box">
      <h3>Aktuel Status</h3>
      <h1 id="currentStatus">Henter data...</h1>
    </div>
    
    <!-- Stats Box -->
    <div class="stats-box">
      <!-- “Aktuel Åbning” + “Tid siden sidste åbning” -->
      <div class="stat-group">
        <h2 class="stat-counter"><span id="currentOpeningDuration">00:00:00</span></h2>
        <p>Aktuel åbning</p>
      </div>
      <div class="stat-group">
        <h2 class="stat-counter"><span id="timeSinceLastOpen">00:00:00</span></h2>
        <p>Tid siden sidste åbning</p>
      </div>

      <!-- Big Box container -->
      <div class="stat-big-box">
        <div class="ios-slider">
          <button id="iosToggleAll"   class="ios-toggle-btn active">Total</button>
          <button id="iosToggleMonth" class="ios-toggle-btn">Month</button>
          <button id="iosToggleWeek"  class="ios-toggle-btn">Week</button>
          <button id="iosToggleDay"   class="ios-toggle-btn">Day</button>
        </div>
        <!-- 4 columns of data below the slider -->
        <div class="four-columns">
          <div class="column-box">
            <h2 id="bigBoxOpenings">0</h2>
            <p>Number of Openings</p>
          </div>
          <div class="column-box">
            <h2 id="bigBoxAlarmToggles">0</h2>
            <p>Alarm Toggles</p>
          </div>
          <div class="column-box">
            <h2 id="bigBoxLongestOpen">00:00:00</h2>
            <p>Longest Opening</p>
          </div>
          <div class="column-box">
            <h2 id="bigBoxAvgOpen">00:00:00</h2>
            <p>Avg Opening Time</p>
          </div>
        </div>
      </div>

    <!-- The Log box -->
    <div class="log-box">
      <h2>Log</h2>
      <div id="logEntries"></div>
    </div>
    
    <!-- Enable Audio button below the log -->
    <button id="enableAudioBtn" class="enable-audio-btn">Aktivér alarm-lyd</button>
  </div>

  <!-- Alarm audio (loop) for monitor -->
  <audio id="monitorAlarm" loop style="display:none;">
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.mp3" type="audio/mpeg">
    Din browser understøtter ikke afspilning af alarm-lyd.
  </audio>
</body>
</html>
