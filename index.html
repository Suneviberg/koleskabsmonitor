<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <title>Køleskabsdetektor v3000 – Overvågning</title>
  <link rel="stylesheet" href="monitorStyles.css">

  <!-- Firebase Modules (ES Modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // Firebase configuration (must match the Detector configuration)
    const firebaseConfig = {
      apiKey: "AIzaSyBk_0onk9XhXjEj6a7gLGunDAdRAuypOkw",
      authDomain: "fridgedetector.firebaseapp.com",
      databaseURL: "https://fridgedetector-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "fridgedetector",
      storageBucket: "fridgedetector.firebasestorage.app",
      messagingSenderId: "715913930919",
      appId: "1:715913930919:web:b3a3a36bc4341579a71382"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    window.FridgeDB = { db };
  </script>

  <!-- Main Monitor Script -->
  <script type="module">
    import { getDatabase, ref, onValue, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    
    // Set the 45-second threshold for the alarm
    const ALARM_THRESHOLD_MS = 45000;
    let alarmIsPlaying = false;
    let monitorInterval = null; // for local stopwatch when fridge is open
    let currentOpenStart = 0;
    
    // Array to hold log entries for statistics
    let allLogs = [];
    
    // Statistics variables (for all periods)
    // We will calculate these inside updateStatistics()
    
    // Global variable to keep track of the current toggle selection
    let currentPeriod = "måned"; // default: "måned"; allowed values: "dag", "uge", "måned"
    
    // For tracking the last closing timestamp (for "time since last open")
    let lastLogEndTime = 0;
    
    document.addEventListener('DOMContentLoaded', () => {
      // Grab UI elements
      const currentStatusEl = document.getElementById('currentStatus');
      const statusBox = document.querySelector('.status-box'); // used for dynamic coloring
      const logEntriesEl = document.getElementById('logEntries');
      
      // Toggle container (new)
      const toggleContainer = document.getElementById('toggleContainer');
      const dayBtn = document.getElementById('toggleDay');
      const weekBtn = document.getElementById('toggleWeek');
      const monthBtn = document.getElementById('toggleMonth');
      
      // Statistics elements for toggle group
      const toggleCountEl = document.getElementById('toggleCount');
      const toggleAvgEl = document.getElementById('toggleAverage');
      
      // Statistics elements for "Alle" (all time) (if desired, you may leave these as before)
      const totalBoxCountEl = document.getElementById('totalAllCount');
      const totalBoxAvgEl   = document.getElementById('averageAllTime');
      
      // Current opening and time since last open
      const currentOpenEl = document.getElementById('currentOpeningDuration');
      const timeSinceOpenEl = document.getElementById('timeSinceLastOpen');
      
      // Alarm audio and Enable Audio Button
      const alarmAudio = document.getElementById('monitorAlarm');
      const enableAudioBtn = document.getElementById('enableAudioBtn');
      
      // Enable audio unlocking via user click
      enableAudioBtn.addEventListener('click', () => {
        const oldVol = alarmAudio.volume;
        alarmAudio.volume = 0;
        alarmAudio.play().then(() => {
          alarmAudio.pause();
          alarmAudio.currentTime = 0;
          alarmAudio.volume = oldVol;
          console.log("Monitor alarm unlocked via user interaction.");
        }).catch(err => {
          console.warn("Monitor audio unlock failed:", err);
        });
      });
      
      // Set up toggle buttons
      dayBtn.addEventListener('click', () => { 
        currentPeriod = "dag"; 
        updateToggleDisplay();
        updateToggleStatistics();
      });
      weekBtn.addEventListener('click', () => { 
        currentPeriod = "uge"; 
        updateToggleDisplay();
        updateToggleStatistics();
      });
      monthBtn.addEventListener('click', () => { 
        currentPeriod = "måned"; 
        updateToggleDisplay();
        updateToggleStatistics();
      });
      
      function updateToggleDisplay() {
        // Remove active class from all, then add it to the selected one.
        dayBtn.classList.remove('active');
        weekBtn.classList.remove('active');
        monthBtn.classList.remove('active');
        if (currentPeriod === "dag") {
          dayBtn.classList.add('active');
        } else if (currentPeriod === "uge") {
          weekBtn.classList.add('active');
        } else if (currentPeriod === "måned") {
          monthBtn.classList.add('active');
        }
      }
      
      updateToggleDisplay(); // set initial state

      // Firebase Database References
      const db = window.FridgeDB.db;
      const currentStatusRef = ref(db, 'fridge/currentStatus');
      const logsRef = ref(db, 'fridge/logs');
      
      // Listen for current status changes
      onValue(currentStatusRef, snapshot => {
        const val = snapshot.val();
        if (!val) {
          currentStatusEl.textContent = "Ingen status endnu...";
          stopMonitorWatch();
          stopAlarm(alarmAudio);
          return;
        }
        currentStatusEl.textContent = val.isOpen ? "Åbent" : "Lukket";
        // Update background color according to state:
        if (val.isOpen) {
          statusBox.style.backgroundColor = "#660000"; // Åbent color (modified from before)
          if (!currentOpenStart || currentOpenStart === 0) {
            currentOpenStart = val.startTime || Date.now();
            startMonitorWatch(alarmAudio);
          }
        } else {
          statusBox.style.backgroundColor = "#1a6600"; // Lukket color
          stopMonitorWatch();
          stopAlarm(alarmAudio);
          updateTimeSinceLastOpen();
          currentOpenStart = 0;
        }
      });
      
      // Listen for new log entries
      onChildAdded(logsRef, snapshot => {
        const entry = snapshot.val();
        if (!entry) return;
        addLogEntry(logEntriesEl, entry);
        allLogs.push(entry);
        updateAllStatistics();
        updateToggleStatistics();
      });
      
      // Update dynamic stats every second
      setInterval(() => {
        if (document.getElementById('currentStatus').textContent === "Åbent" && currentOpenStart) {
          currentOpenEl.textContent = formatTime(Date.now() - currentOpenStart);
        } else {
          currentOpenEl.textContent = "00:00:00";
        }
        if (document.getElementById('currentStatus').textContent === "Lukket" && lastLogEndTime) {
          updateTimeSinceLastOpen();
        }
      }, 1000);
      
      function updateAllStatistics() {
        // Calculate All-Time statistics regardless of toggle selection
        let count = 0, total = 0;
        for (const entry of allLogs) {
          count++;
          total += entry.durationMs || 0;
        }
        totalBoxCountEl.textContent = count;
        totalBoxAvgEl.textContent = count > 0 ? formatTime(total / count) : "00:00:00";
      }
      
      function updateToggleStatistics() {
        let count = 0, total = 0;
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();
        const currentDate = now.getDate();
        // For week, consider entries from the last 7 days
        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        
        for (const entry of allLogs) {
          const entryDate = new Date(entry.start);
          if (currentPeriod === "måned") {
            if (entryDate.getFullYear() === currentYear && entryDate.getMonth() === currentMonth) {
              count++;
              total += entry.durationMs || 0;
            }
          } else if (currentPeriod === "uge") {
            if (entryDate >= weekAgo) {
              count++;
              total += entry.durationMs || 0;
            }
          } else if (currentPeriod === "dag") {
            if (entryDate.getFullYear() === currentYear &&
                entryDate.getMonth() === currentMonth &&
                entryDate.getDate() === currentDate) {
              count++;
              total += entry.durationMs || 0;
            }
          }
        }
        document.getElementById('toggleCount').textContent = count;
        document.getElementById('toggleAverage').textContent = count > 0 ? formatTime(total / count) : "00:00:00";
      }
    });
    
    function startMonitorWatch(alarmAudio) {
      if (monitorInterval) return;
      monitorInterval = setInterval(() => {
        const elapsed = Date.now() - currentOpenStart;
        if (elapsed >= ALARM_THRESHOLD_MS && !alarmIsPlaying) {
          startAlarm(alarmAudio);
        }
      }, 500);
    }
    
    function stopMonitorWatch() {
      if (monitorInterval) {
        clearInterval(monitorInterval);
        monitorInterval = null;
      }
    }
    
    function startAlarm(alarmAudio) {
      alarmIsPlaying = true;
      try {
        alarmAudio.play().catch(err => {
          console.warn("Monitor alarm error:", err);
        });
      } catch (err) {
        console.warn("Monitor alarm exception:", err);
      }
    }
    
    function stopAlarm(alarmAudio) {
      alarmIsPlaying = false;
      if (!alarmAudio.paused) {
        alarmAudio.pause();
        alarmAudio.currentTime = 0;
      }
    }
    
    function addLogEntry(container, entry) {
      const div = document.createElement('div');
      const startStr = formatClockTime(new Date(entry.start));
      const endStr = formatClockTime(new Date(entry.end));
      const durStr = formatTime(entry.durationMs || 0);
      div.textContent = `Åbnet: ${startStr} - ${endStr} (Varighed: ${durStr})`;
      container.prepend(div);
      lastLogEndTime = entry.end;
    }
    
    function updateTimeSinceLastOpen() {
      if (!lastLogEndTime) return;
      const elapsed = Date.now() - lastLogEndTime;
      document.getElementById('timeSinceLastOpen').textContent = formatTime(elapsed);
    }
    
    function formatTime(ms) {
      let totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      totalSeconds %= 3600;
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return [hours, minutes, seconds].map(n => String(n).padStart(2, '0')).join(':');
    }
    
    function formatClockTime(dateObj) {
      const hh = String(dateObj.getHours()).padStart(2, '0');
      const mm = String(dateObj.getMinutes()).padStart(2, '0');
      const ss = String(dateObj.getSeconds()).padStart(2, '0');
      return `${hh}:${mm}:${ss}`;
    }
  </script>
</head>
<body>
  <div class="monitor-container">
    <h1>Køleskabsdetektor v3000 – Overvågning</h1>
    
    <div class="status-box">
      <h3>Aktuel Status</h3>
      <h1 id="currentStatus">Henter data...</h1>
    </div>
    
    <div class="stats-box">
      <!-- "Alle" statistics box (always shown) -->
      <div class="stat-group">
        <h3>Alle</h3>
        <p>Antal åbninger: <span id="totalAllCount">0</span></p>
        <p>Gennemsnitlig åbningstid: <span id="averageAllTime">00:00:00</span></p>
      </div>
      
      <!-- Toggle controls for Day, Week, Month -->
      <div class="stat-big-box">
        <div id="toggleContainer">
          <button id="toggleDag" class="toggle-btn">Dag</button>
          <button id="toggleUge" class="toggle-btn">Uge</button>
          <button id="toggleMåned" class="toggle-btn active">Måned</button>
        </div>
        <div id="toggleStats">
          <p>Antal åbninger: <span id="toggleCount">0</span></p>
          <p>Gennemsnitlig åbningstid: <span id="toggleAverage">00:00:00</span></p>
        </div>
      </div>
      
      <!-- Current opening duration -->
      <div class="stat-group">
        <h3>Aktuel åbning</h3>
        <p>Varighed: <span id="currentOpeningDuration">00:00:00</span></p>
      </div>
      
      <!-- Time since last open -->
      <div class="stat-group">
        <h3>Siden sidst åbnet</h3>
        <p>Tid: <span id="timeSinceLastOpen">00:00:00</span></p>
      </div>
    </div>
    
    <div class="log-box">
      <h2>Log</h2>
      <div id="logEntries"></div>
    </div>
    
    <!-- Enable Audio button moved below the log -->
    <button id="enableAudioBtn" class="enable-audio-btn">Aktivér alarm-lyd</button>
  </div>

  <!-- Alarm audio (loop) for monitor -->
  <audio id="monitorAlarm" loop style="display:none;">
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.mp3" type="audio/mpeg">
    Din browser understøtter ikke afspilning af alarm-lyd.
  </audio>
</body>
</html>
